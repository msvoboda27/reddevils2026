<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Red Devils 2026 ‚Äî Draft Day (Version B + Logger)</title>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Roboto+Condensed:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --navy:#1a2744; --navy-light:#2d4263;
            --gold:#d4af37; --gold-light:#f4d675;
            --red:#c41e3a; --green:#2e7d32;
            --white:#f5f5f5;
        }
        *{margin:0;padding:0;box-sizing:border-box;}
        html,body{height:100%;overflow:hidden;}
        body{
            font-family:'Roboto Condensed',sans-serif;
            background:linear-gradient(135deg,var(--navy) 0%,#0d1520 100%);
            color:var(--white);display:flex;flex-direction:column;
        }

        /* ‚îÄ‚îÄ Loading ‚îÄ‚îÄ */
        #loader{
            position:fixed;inset:0;background:var(--navy);
            display:flex;flex-direction:column;align-items:center;justify-content:center;
            z-index:9999;transition:opacity .5s;
        }
        #loader.gone{opacity:0;pointer-events:none;}
        .spin{width:56px;height:56px;border-radius:50%;border:5px solid rgba(212,175,55,.3);border-top-color:var(--gold);animation:spin 1s linear infinite;margin-bottom:16px;}
        @keyframes spin{to{transform:rotate(360deg);}}
        .load-title{font-family:'Oswald',sans-serif;font-size:1.4rem;color:var(--gold);}
        .load-sub{font-size:.85rem;opacity:.6;margin-top:6px;}

        /* ‚îÄ‚îÄ Top Banner ‚îÄ‚îÄ */
        #top-banner{
            background:linear-gradient(90deg,var(--red),#8b0000);
            border-bottom:3px solid var(--gold);
            padding:8px 16px;
            display:flex;align-items:center;justify-content:space-between;
            flex-shrink:0;gap:12px;
        }
        #top-banner h1{font-family:'Oswald',sans-serif;font-size:1.4rem;text-transform:uppercase;letter-spacing:2px;white-space:nowrap;}
        #banner-center{font-family:'Oswald',sans-serif;font-size:1rem;text-align:center;flex:1;}
        #current-pick-label{font-size:1.2rem;font-weight:700;}
        #on-deck-label{font-size:.78rem;opacity:.65;margin-top:1px;}
        #your-turn-pill{
            padding:7px 16px;border-radius:6px;
            font-family:'Oswald',sans-serif;font-size:.9rem;font-weight:700;white-space:nowrap;
        }
        #your-turn-pill.active{background:var(--green);color:#fff;animation:pulse 1.5s infinite;}
        #your-turn-pill.waiting{background:rgba(255,255,255,.1);color:var(--gold);}
        @keyframes pulse{0%,100%{transform:scale(1);}50%{transform:scale(1.05);box-shadow:0 0 18px rgba(46,125,50,.8);}}

        /* ‚îÄ‚îÄ Pick Logger Bar ‚îÄ‚îÄ */
        #logger-bar{
            background:rgba(0,0,0,.4);
            border-bottom:2px solid rgba(212,175,55,.3);
            padding:8px 16px;
            display:flex;align-items:center;gap:10px;
            flex-shrink:0;
        }
        #logger-label{
            font-family:'Oswald',sans-serif;font-size:.85rem;
            text-transform:uppercase;letter-spacing:1px;
            color:var(--gold);white-space:nowrap;
        }
        #logger-owner-display{
            background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);
            padding:5px 12px;border-radius:4px;
            font-family:'Oswald',sans-serif;font-size:.95rem;
            min-width:90px;text-align:center;
        }
        #logger-input{
            flex:1;background:rgba(255,255,255,.1);
            border:1px solid rgba(212,175,55,.4);
            color:#fff;padding:7px 14px;border-radius:4px;
            font-family:'Roboto Condensed',sans-serif;font-size:1rem;
            outline:none;
        }
        #logger-input:focus{border-color:var(--gold);background:rgba(255,255,255,.15);}
        #logger-input::placeholder{opacity:.4;}
        #logger-pos{
            background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.2);
            color:#fff;padding:7px 10px;border-radius:4px;
            font-family:'Roboto Condensed',sans-serif;font-size:.9rem;
            width:70px;outline:none;
        }
        #log-btn{
            background:var(--gold);color:var(--navy);
            border:none;padding:7px 20px;border-radius:4px;
            font-family:'Oswald',sans-serif;font-size:1rem;font-weight:700;
            cursor:pointer;white-space:nowrap;transition:background .15s;
        }
        #log-btn:hover{background:var(--gold-light);}
        #log-btn:disabled{background:rgba(212,175,55,.3);color:rgba(0,0,0,.4);cursor:default;}
        #undo-btn{
            background:rgba(255,99,99,.2);border:1px solid rgba(255,99,99,.4);
            color:#ff9999;padding:7px 14px;border-radius:4px;
            font-family:'Oswald',sans-serif;font-size:.85rem;cursor:pointer;
        }
        #undo-btn:hover{background:rgba(255,99,99,.35);}
        #logger-status{font-size:.78rem;min-width:120px;text-align:center;}
        .status-ok{color:#4caf50;}
        .status-err{color:#f44336;}
        .status-saving{color:var(--gold);}
        #autocomplete-box{
            position:absolute;background:var(--navy-light);
            border:1px solid var(--gold);border-radius:4px;
            max-height:200px;overflow-y:auto;z-index:500;
            min-width:300px;box-shadow:0 4px 20px rgba(0,0,0,.5);
        }
        .ac-item{
            padding:8px 14px;cursor:pointer;font-size:.9rem;
            border-bottom:1px solid rgba(255,255,255,.06);
        }
        .ac-item:hover{background:rgba(212,175,55,.2);}
        .ac-item span{opacity:.5;font-size:.78rem;margin-left:8px;}

        /* ‚îÄ‚îÄ Round Strip ‚îÄ‚îÄ */
        #round-strip{
            background:rgba(0,0,0,.25);padding:6px 16px;
            display:flex;gap:5px;align-items:center;overflow-x:auto;flex-shrink:0;
        }
        .round-label{font-family:'Oswald',sans-serif;font-size:.75rem;opacity:.45;margin-right:4px;}
        .rs-slot{
            padding:4px 10px;border-radius:5px;text-align:center;
            font-family:'Oswald',sans-serif;font-size:.8rem;
            background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);
            white-space:nowrap;
        }
        .rs-slot.you{border-color:var(--gold);color:var(--gold);}
        .rs-slot.active{background:var(--gold);color:var(--navy);border-color:var(--gold);font-weight:700;}
        .rs-slot.done{opacity:.25;}

        /* ‚îÄ‚îÄ Main Grid ‚îÄ‚îÄ */
        #main-grid{
            flex:1;display:grid;
            grid-template-columns:1fr 370px;
            grid-template-rows:1fr auto;
            overflow:hidden;
        }

        /* ‚îÄ‚îÄ Draft Log ‚îÄ‚îÄ */
        #draft-log-panel{
            grid-row:1;grid-column:1;
            display:flex;flex-direction:column;
            border-right:1px solid rgba(255,255,255,.07);overflow:hidden;
        }
        .panel-header{
            background:var(--navy-light);padding:9px 14px;
            font-family:'Oswald',sans-serif;font-size:.95rem;
            text-transform:uppercase;letter-spacing:2px;
            border-bottom:2px solid var(--gold);flex-shrink:0;
            display:flex;justify-content:space-between;align-items:center;
        }
        #draft-log-scroll{flex:1;overflow-y:auto;}
        #draft-log-scroll::-webkit-scrollbar{width:5px;}
        #draft-log-scroll::-webkit-scrollbar-thumb{background:var(--gold);border-radius:3px;}

        .pick-row{
            display:grid;grid-template-columns:50px 88px 1fr 52px;
            padding:7px 14px;border-bottom:1px solid rgba(255,255,255,.055);
            align-items:center;transition:background .12s;
        }
        .pick-row:hover{background:rgba(255,255,255,.045);}
        .pick-row.yours{background:rgba(212,175,55,.11);border-left:3px solid var(--gold);}
        .pick-row.current{background:rgba(212,175,55,.07);border-left:3px solid rgba(212,175,55,.35);}
        .pick-row.empty{opacity:.28;}
        .pr-num{font-family:'Oswald',sans-serif;font-size:.95rem;color:var(--gold);}
        .pr-owner{font-size:.78rem;opacity:.55;font-weight:700;}
        .pr-player{font-size:.98rem;font-weight:700;}
        .pr-player.click{cursor:pointer;color:var(--gold-light);}
        .pr-player.click:hover{text-decoration:underline;}
        .pr-pos{background:var(--navy);padding:2px 7px;border-radius:3px;font-size:.75rem;font-weight:700;text-align:center;}

        /* ‚îÄ‚îÄ Available ‚îÄ‚îÄ */
        #avail-panel{
            grid-row:2;grid-column:1;
            border-right:1px solid rgba(255,255,255,.07);
            border-top:1px solid rgba(255,255,255,.07);
            display:flex;flex-direction:column;max-height:38vh;
        }
        .pos-filters{display:flex;gap:4px;padding:7px 14px;flex-wrap:wrap;flex-shrink:0;}
        .pf-btn{
            padding:3px 10px;border-radius:18px;border:1px solid rgba(255,255,255,.18);
            background:rgba(255,255,255,.06);color:#fff;cursor:pointer;font-size:.75rem;transition:all .12s;
        }
        .pf-btn.active{background:var(--gold);color:var(--navy);border-color:var(--gold);}
        #avail-scroll{flex:1;overflow-y:auto;}
        #avail-scroll::-webkit-scrollbar{width:5px;}
        #avail-scroll::-webkit-scrollbar-thumb{background:var(--gold);border-radius:3px;}
        .avail-row{
            display:grid;grid-template-columns:34px 1fr 42px 38px 44px 44px 44px 48px;
            padding:5px 14px;border-bottom:1px solid rgba(255,255,255,.045);
            font-size:.8rem;align-items:center;cursor:pointer;
        }
        .avail-row:hover{background:rgba(255,255,255,.055);}
        .avail-row.hdr{background:var(--navy);font-family:'Oswald',sans-serif;font-size:.72rem;text-transform:uppercase;cursor:default;position:sticky;top:0;}
        .a-rank{color:var(--gold);font-weight:700;}
        .a-name{font-weight:700;color:var(--gold-light);}

        /* ‚îÄ‚îÄ Right Col ‚îÄ‚îÄ */
        #right-col{grid-row:1/3;grid-column:2;display:flex;flex-direction:column;overflow:hidden;}

        /* Your Team */
        #your-team-panel{flex:0 0 auto;border-bottom:1px solid rgba(255,255,255,.07);}
        .your-hdr{background:linear-gradient(90deg,var(--gold),var(--gold-light));color:var(--navy)!important;}
        #your-roster{padding:8px 12px;overflow-y:auto;max-height:25vh;}
        #your-roster::-webkit-scrollbar{width:4px;}
        #your-roster::-webkit-scrollbar-thumb{background:var(--gold);border-radius:2px;}
        .ri{display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px solid rgba(255,255,255,.045);font-size:.82rem;}
        .ri-rnd{color:var(--gold);font-size:.72rem;width:22px;flex-shrink:0;}
        .ri-nm{flex:1;padding:0 5px;}
        .ri-ps{font-size:.7rem;opacity:.5;}
        #needs-bar{padding:6px 12px;display:flex;flex-wrap:wrap;gap:3px;}
        .need-tag{background:var(--red);color:#fff;padding:2px 7px;border-radius:10px;font-size:.7rem;font-weight:700;}
        #next-pick-box{margin:0 12px 8px;padding:7px 10px;background:rgba(212,175,55,.12);border:1px solid rgba(212,175,55,.35);border-radius:5px;font-size:.8rem;}
        .npb-lbl{color:var(--gold);font-family:'Oswald',sans-serif;font-size:.75rem;text-transform:uppercase;letter-spacing:1px;margin-bottom:3px;}

        /* Standings */
        #standings-panel{flex:1;display:flex;flex-direction:column;overflow:hidden;}
        #standings-scroll{flex:1;overflow-y:auto;}
        #standings-scroll::-webkit-scrollbar{width:4px;}
        #standings-scroll::-webkit-scrollbar-thumb{background:var(--gold);border-radius:2px;}
        .st-table{width:100%;border-collapse:collapse;font-size:.75rem;}
        .st-table th{background:var(--navy);padding:6px 4px;text-align:center;font-family:'Oswald',sans-serif;font-size:.68rem;text-transform:uppercase;position:sticky;top:0;}
        .st-table td{padding:5px 4px;text-align:center;border-bottom:1px solid rgba(255,255,255,.06);}
        .st-own{text-align:left!important;padding-left:8px!important;font-weight:700;font-size:.78rem;}
        .st-you{background:rgba(212,175,55,.11);border-left:3px solid var(--gold);}
        .r1{color:#4caf50;font-weight:700;}.r2{color:#8bc34a;}.r3{color:#cddc39;}
        .r4{color:#ffeb3b;}.r5{color:#ff9800;}.r6{color:#ff5722;}.r7{color:#f44336;font-weight:700;}
        .st-tot{font-family:'Oswald',sans-serif;font-size:.88rem;font-weight:700;color:var(--gold);}

        /* ‚îÄ‚îÄ Player Modal ‚îÄ‚îÄ */
        #player-modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:1000;align-items:center;justify-content:center;}
        #player-modal.open{display:flex;}
        #modal-box{background:linear-gradient(135deg,var(--navy-light),var(--navy));border:2px solid var(--gold);border-radius:12px;padding:22px;width:460px;max-width:95vw;position:relative;}
        #modal-close{position:absolute;top:10px;right:14px;background:none;border:none;color:var(--gold);font-size:1.3rem;cursor:pointer;}
        #modal-name{font-family:'Oswald',sans-serif;font-size:1.5rem;font-weight:700;margin-bottom:3px;}
        #modal-sub{opacity:.6;font-size:.85rem;margin-bottom:14px;}
        .modal-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px;}
        .stat-box{background:rgba(255,255,255,.06);border-radius:6px;padding:9px;text-align:center;}
        .stat-val{font-family:'Oswald',sans-serif;font-size:1.3rem;font-weight:700;color:var(--gold);}
        .stat-lbl{font-size:.7rem;opacity:.55;text-transform:uppercase;margin-top:1px;}
        #modal-why{background:rgba(212,175,55,.08);border:1px solid rgba(212,175,55,.25);border-radius:6px;padding:11px;font-size:.85rem;line-height:1.55;}
        #modal-why-title{font-family:'Oswald',sans-serif;color:var(--gold);font-size:.75rem;text-transform:uppercase;letter-spacing:1px;margin-bottom:5px;}
        #modal-draft-btn{
            width:100%;margin-top:12px;background:var(--green);border:none;color:#fff;
            padding:10px;border-radius:6px;font-family:'Oswald',sans-serif;font-size:1rem;
            font-weight:700;cursor:pointer;transition:background .15s;
        }
        #modal-draft-btn:hover{background:#1b5e20;}

        /* Setup modal */
        #setup-modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:2000;align-items:center;justify-content:center;}
        #setup-modal.open{display:flex;}
        #setup-box{background:var(--navy-light);border:2px solid var(--gold);border-radius:12px;padding:28px;width:520px;max-width:95vw;}
        #setup-box h2{font-family:'Oswald',sans-serif;font-size:1.4rem;color:var(--gold);margin-bottom:8px;}
        #setup-box p{font-size:.88rem;opacity:.75;margin-bottom:16px;line-height:1.5;}
        #setup-url{width:100%;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.25);color:#fff;padding:9px 12px;border-radius:4px;font-size:.88rem;margin-bottom:12px;}
        #setup-save{background:var(--gold);color:var(--navy);border:none;padding:10px 24px;border-radius:4px;font-family:'Oswald',sans-serif;font-size:1rem;font-weight:700;cursor:pointer;width:100%;}
        .setup-skip{display:block;text-align:center;margin-top:10px;font-size:.8rem;opacity:.5;cursor:pointer;}
        .setup-skip:hover{opacity:.8;}
    </style>
</head>
<body>

<div id="loader">
    <div class="spin"></div>
    <div class="load-title">üî¥ Red Devils 2026 ‚Äî Version B</div>
    <div class="load-sub" id="load-sub">Connecting to Google Sheets...</div>
</div>

<!-- Setup Modal (for Apps Script URL) -->
<div id="setup-modal">
    <div id="setup-box">
        <h2>‚öôÔ∏è One-Time Setup: Pick Logger</h2>
        <p>To log picks directly from this dashboard, you need to paste your <strong>Google Apps Script Web App URL</strong> below. This lets the dashboard write picks back to your Google Sheet.<br><br>
        If you haven't set this up yet, click "Skip for now" ‚Äî the dashboard still works as a read-only display.</p>
        <input id="setup-url" type="text" placeholder="https://script.google.com/macros/s/.../exec" />
        <button id="setup-save" onclick="saveScriptUrl()">Save & Enable Pick Logger</button>
        <span class="setup-skip" onclick="skipSetup()">Skip for now ‚Äî use read-only mode</span>
    </div>
</div>

<!-- Top Banner -->
<div id="top-banner">
    <h1>üî¥ Red Devils 2026 <span style="font-size:.8rem;opacity:.5">v B</span></h1>
    <div id="banner-center">
        <div id="current-pick-label">Loading...</div>
        <div id="on-deck-label"></div>
    </div>
    <div style="display:flex;align-items:center;gap:8px;flex-shrink:0">
        <div id="your-turn-pill" class="waiting">Loading...</div>
        <button style="background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);color:#fff;padding:5px 10px;border-radius:4px;cursor:pointer;font-size:.8rem" onclick="loadAll()">üîÑ</button>
        <button style="background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.15);color:#fff;padding:5px 10px;border-radius:4px;cursor:pointer;font-size:.8rem" onclick="openSetup()">‚öôÔ∏è</button>
    </div>
</div>

<!-- Pick Logger Bar -->
<div id="logger-bar">
    <span id="logger-label">üìù Log Pick:</span>
    <div id="logger-owner-display">‚Äî</div>
    <div style="position:relative;flex:1">
        <input id="logger-input" type="text" placeholder="Start typing player name..." autocomplete="off" oninput="onLoggerInput(this.value)" onkeydown="onLoggerKey(event)" />
        <div id="autocomplete-box" style="display:none;position:absolute;top:100%;left:0;right:0"></div>
    </div>
    <select id="logger-pos">
        <option value="">Pos</option>
        <option>C</option><option>1B</option><option>2B</option><option>3B</option>
        <option>SS</option><option>OF</option><option>SP</option><option>RP</option><option>DH</option>
    </select>
    <button id="log-btn" onclick="logPick()">LOG PICK ‚Üµ</button>
    <button id="undo-btn" onclick="undoPick()">‚Ü© Undo</button>
    <div id="logger-status"></div>
</div>

<!-- Round Strip -->
<div id="round-strip">
    <span class="round-label">RD</span>
    <span id="round-num" style="font-family:'Oswald',sans-serif;color:var(--gold);margin-right:6px;font-size:.9rem">1</span>
    <div id="rs-slots" style="display:flex;gap:5px"></div>
</div>

<!-- Main Grid -->
<div id="main-grid">

    <!-- Draft Log -->
    <div id="draft-log-panel">
        <div class="panel-header">
            üìã Draft Log
            <span id="picks-count" style="font-size:.75rem;opacity:.55">0 / 161</span>
        </div>
        <div id="draft-log-scroll"></div>
    </div>

    <!-- Available Players -->
    <div id="avail-panel">
        <div class="panel-header">
            ‚öæ Available Players
            <span id="avail-count" style="font-size:.75rem;opacity:.55"></span>
        </div>
        <div class="pos-filters">
            <button class="pf-btn active" onclick="filterPos('ALL',this)">All</button>
            <button class="pf-btn" onclick="filterPos('C',this)">C</button>
            <button class="pf-btn" onclick="filterPos('1B',this)">1B</button>
            <button class="pf-btn" onclick="filterPos('2B',this)">2B</button>
            <button class="pf-btn" onclick="filterPos('3B',this)">3B</button>
            <button class="pf-btn" onclick="filterPos('SS',this)">SS</button>
            <button class="pf-btn" onclick="filterPos('OF',this)">OF</button>
            <button class="pf-btn" onclick="filterPos('SP',this)">SP</button>
            <button class="pf-btn" onclick="filterPos('RP',this)">RP/CL</button>
        </div>
        <div id="avail-scroll">
            <table style="width:100%;border-collapse:collapse">
                <thead><tr class="avail-row hdr"><td>#</td><td>Player</td><td>Pos</td><td>Tm</td><td>HR/W</td><td>R/SV</td><td>RBI/K</td><td>WAR</td></tr></thead>
                <tbody id="avail-body"></tbody>
            </table>
        </div>
    </div>

    <!-- Right Col -->
    <div id="right-col">
        <div id="your-team-panel">
            <div class="panel-header your-hdr">‚≠ê QUICKSTER ‚Äî YOUR TEAM</div>
            <div id="your-roster"></div>
            <div id="needs-bar"></div>
            <div id="next-pick-box">
                <div class="npb-lbl">‚è± Next Pick</div>
                <div id="next-pick-detail">Loading...</div>
            </div>
        </div>
        <div id="standings-panel">
            <div class="panel-header">üìä Live Roto Standings</div>
            <div id="standings-scroll">
                <table class="st-table">
                    <thead><tr>
                        <th class="st-own">Owner</th>
                        <th>HR</th><th>R</th><th>RBI</th><th>SB</th><th>AVG</th>
                        <th>W</th><th>SV</th><th>ERA</th><th>WHIP</th><th>TOT</th>
                    </tr></thead>
                    <tbody id="standings-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Player Modal -->
<div id="player-modal">
    <div id="modal-box">
        <button id="modal-close" onclick="closeModal()">‚úï</button>
        <div id="modal-name"></div>
        <div id="modal-sub"></div>
        <div class="modal-stats" id="modal-stats"></div>
        <div id="modal-why">
            <div id="modal-why-title">üí° Why Draft This Player?</div>
            <div id="modal-why-text"></div>
        </div>
        <button id="modal-draft-btn" onclick="draftFromModal()">+ LOG THIS PICK</button>
    </div>
</div>

<script>
const URLS = {
    draftBoard:'https://docs.google.com/spreadsheets/d/e/2PACX-1vQyBE1r8gfR4CJXJcHQLrmGTCpzDfYzCaQOeKe75RblsR_HR2q76GRWfyl8PTK2yQ/pub?gid=1638949988&single=true&output=csv',
    hitters:'https://docs.google.com/spreadsheets/d/e/2PACX-1vQyBE1r8gfR4CJXJcHQLrmGTCpzDfYzCaQOeKe75RblsR_HR2q76GRWfyl8PTK2yQ/pub?gid=150056456&single=true&output=csv',
    pitchers:'https://docs.google.com/spreadsheets/d/e/2PACX-1vQyBE1r8gfR4CJXJcHQLrmGTCpzDfYzCaQOeKe75RblsR_HR2q76GRWfyl8PTK2yQ/pub?gid=563628934&single=true&output=csv',
    keepers:'https://docs.google.com/spreadsheets/d/e/2PACX-1vQyBE1r8gfR4CJXJcHQLrmGTCpzDfYzCaQOeKe75RblsR_HR2q76GRWfyl8PTK2yQ/pub?gid=1016378708&single=true&output=csv',
};
const OWNERS=['Bubs','Furman','Quickster','Cone','Vic','TK','Rich'];
const YOU='Quickster';
const ROUNDS=23;

function buildSnake(){
    const o=[];
    for(let r=1;r<=ROUNDS;r++){
        const row=r%2===1?[...OWNERS]:[...OWNERS].reverse();
        row.forEach((owner,i)=>o.push({pick:o.length+1,round:r,rp:i+1,owner}));
    }
    return o;
}
const SNAKE=buildSnake();

function parseCSV(txt){
    const lines=txt.trim().split('\n');
    const hdr=parseLine(lines[0]);
    return lines.slice(1).filter(l=>l.trim()).map(l=>{
        const v=parseLine(l);const o={};
        hdr.forEach((h,i)=>o[h.trim()]=(v[i]||'').trim());
        return o;
    });
}
function parseLine(line){
    const r=[];let c='',q=false;
    for(let ch of line){if(ch==='"'){q=!q;}else if(ch===','&&!q){r.push(c);c='';}else c+=ch;}
    r.push(c);return r;
}
async function csv(url){const r=await fetch(url);if(!r.ok)throw new Error('fetch failed');return parseCSV(await r.text());}

// Local picks stored in memory (for instant feedback before sheet syncs)
let localPicks = {};  // pick# -> {player, pos}
let scriptUrl = localStorage.getItem('rd_script_url') || '';
let modalCurrentPlayer = null;

let S={db:[],hitters:[],pitchers:[],keepers:[],pmap:{},drafted:new Set(),posFilter:'ALL'};

async function loadAll(){
    try{
        const[db,h,p,k]=await Promise.all([csv(URLS.draftBoard),csv(URLS.hitters),csv(URLS.pitchers),csv(URLS.keepers)]);
        S.db=db;S.hitters=h;S.pitchers=p;S.keepers=k;
        S.pmap={};
        h.forEach(p=>{if(p.Name)S.pmap[n(p.Name)]={...p,_type:'h'};});
        p.forEach(p=>{if(p.Name)S.pmap[n(p.Name)]={...p,_type:'p'};});
        // Merge sheet data with local picks
        S.drafted=new Set();
        db.forEach(row=>{const pl=(row.Player||'').trim();if(pl)S.drafted.add(n(pl));});
        Object.values(localPicks).forEach(lp=>S.drafted.add(n(lp.player)));
        renderAll();
    }catch(e){console.error(e);}
    const ld=document.getElementById('loader');
    ld.classList.add('gone');setTimeout(()=>ld.style.display='none',600);
}

function n(s){return(s||'').toLowerCase().trim();}

function computePicks(){
    const map={};
    S.db.forEach(row=>{
        const num=parseInt(row['Pick#']||row['Pick #']||0);
        if(!num)return;
        const pl=(row.Player||'').trim();
        if(pl)map[num]={player:pl,pos:(row.Position||'').trim()};
    });
    // overlay local picks
    Object.entries(localPicks).forEach(([num,d])=>{map[parseInt(num)]=d;});
    let curIdx=-1;
    for(let i=0;i<SNAKE.length;i++){if(!map[SNAKE[i].pick]){curIdx=i;break;}}
    if(curIdx===-1)curIdx=SNAKE.length;
    const cur=SNAKE[curIdx]||null;
    const nyp=SNAKE.find((p,i)=>i>=curIdx&&p.owner===YOU)||null;
    const rosters={};OWNERS.forEach(o=>rosters[o]=[]);
    Object.entries(map).forEach(([num,d])=>{
        const info=SNAKE[parseInt(num)-1];
        if(info)rosters[info.owner].push({...d,round:info.round});
    });
    S.keepers.forEach(row=>{
        const owner=(row.Owner||'').replace(' (Mic)','').replace('Quickster (Mic)','Quickster').trim();
        ['1','2'].forEach(i=>{
            const k=(row[`Keeper ${i}`]||'').trim();
            const kp=(row[`K${i} Position`]||'').trim();
            if(k&&k!=='TBD'&&rosters[owner])rosters[owner].unshift({player:k,pos:kp,round:0,isKeeper:true});
        });
    });
    return{curIdx,cur,nyp,map,rosters,madeCount:Object.keys(map).length};
}

function renderAll(){
    const pi=computePicks();
    renderBanner(pi);renderRoundStrip(pi);renderDraftLog(pi);
    renderYourTeam(pi);renderStandings(pi);renderAvail();renderNextPick(pi);
    updateLoggerOwner(pi);
}

function renderBanner(pi){
    const cp=pi.cur;
    if(!cp){document.getElementById('current-pick-label').textContent='üèÜ DRAFT COMPLETE';return;}
    document.getElementById('current-pick-label').textContent=`üìç Pick ${cp.pick} ‚Äî Rd ${cp.round} (${cp.owner.toUpperCase()})`;
    const nxt=SNAKE[pi.curIdx+1];
    document.getElementById('on-deck-label').textContent=nxt?`On deck: ${nxt.owner} (#${nxt.pick})`:'';
    const pill=document.getElementById('your-turn-pill');
    if(cp.owner===YOU){pill.textContent='üî• YOUR TURN!';pill.className='your-turn-pill active';}
    else{pill.textContent=pi.nyp?`Your pick: #${pi.nyp.pick}`:'';pill.className='your-turn-pill waiting';}
    document.getElementById('picks-count').textContent=`${pi.madeCount} / 161`;
}

function updateLoggerOwner(pi){
    const cp=pi.cur;
    const ownerEl=document.getElementById('logger-owner-display');
    if(cp){
        ownerEl.textContent=cp.owner;
        ownerEl.style.color=cp.owner===YOU?'var(--gold)':'var(--white)';
        ownerEl.style.borderColor=cp.owner===YOU?'var(--gold)':'rgba(255,255,255,.15)';
    } else {
        ownerEl.textContent='Done';
    }
}

function renderRoundStrip(pi){
    const cp=pi.cur;const round=cp?cp.round:ROUNDS;
    document.getElementById('round-num').textContent=round;
    const picks=SNAKE.filter(p=>p.round===round);
    document.getElementById('rs-slots').innerHTML=picks.map(p=>{
        let cls='rs-slot';
        if(p.owner===YOU)cls+=' you';
        if(cp&&p.pick===cp.pick)cls+=' active';
        else if(cp&&p.pick<cp.pick)cls+=' done';
        return`<div class="${cls}">${p.rp}. ${p.owner}</div>`;
    }).join('');
}

function renderDraftLog(pi){
    const el=document.getElementById('draft-log-scroll');
    const from=Math.max(0,pi.curIdx-18);
    const to=Math.min(SNAKE.length-1,pi.curIdx+12);
    let html='';
    for(let i=from;i<=to;i++){
        const p=SNAKE[i];const d=pi.map[p.pick];
        const isYou=p.owner===YOU;const isCur=pi.cur&&p.pick===pi.cur.pick;
        let cls='pick-row';
        if(isYou&&d)cls+=' yours';
        if(isCur)cls+=' current';
        if(!d)cls+=' empty';
        const ph=d?`<span class="pr-player click" onclick="showPlayer('${d.player.replace(/'/g,"\\'")}','${d.pos}')">${d.player}</span>`
            :isCur?`<span class="pr-player" style="opacity:.5;font-style:italic">‚è± on clock‚Ä¶</span>`
            :`<span class="pr-player" style="opacity:.18">‚Äî</span>`;
        html+=`<div class="${cls}">
            <span class="pr-num">${p.round}.${String(p.rp).padStart(2,'0')}</span>
            <span class="pr-owner">${isYou?'‚≠ê':''} ${p.owner}</span>
            ${ph}
            <span class="pr-pos">${d?d.pos:''}</span>
        </div>`;
    }
    el.innerHTML=html;
    setTimeout(()=>{const c=el.querySelector('.current');if(c)c.scrollIntoView({behavior:'smooth',block:'center'});},100);
}

function renderYourTeam(pi){
    const roster=pi.rosters[YOU]||[];
    let html='';
    roster.forEach(p=>{
        html+=`<div class="ri">
            <span class="ri-rnd">${p.isKeeper?'üîí':('R'+p.round)}</span>
            <span class="ri-nm">${p.player}</span>
            <span class="ri-ps">${p.pos||''}</span>
        </div>`;
    });
    if(!html)html='<div style="padding:10px;opacity:.35;font-size:.82rem">No picks yet</div>';
    document.getElementById('your-roster').innerHTML=html;
    const posCount={};
    roster.forEach(p=>{const pos=(p.pos||'').toUpperCase();posCount[pos]=(posCount[pos]||0)+1;});
    const needs={C:1,'1B':2,'2B':2,'3B':1,SS:1,MI:1,CI:1,OF:5,SP:6,RP:3,UT:2};
    const tags=[];
    Object.entries(needs).forEach(([pos,req])=>{const have=posCount[pos]||0;if(have<req)tags.push(pos+(req-have>1?` √ó${req-have}`:''));});
    document.getElementById('needs-bar').innerHTML=tags.map(t=>`<span class="need-tag">${t}</span>`).join('')||'<span style="color:#4caf50;font-size:.78rem;padding:6px 12px">‚úÖ All slots filled!</span>';
}

function renderNextPick(pi){
    const nyp=pi.nyp;
    if(!nyp){document.getElementById('next-pick-detail').textContent='No picks remaining';return;}
    const gap=nyp.pick-(pi.cur?pi.cur.pick:nyp.pick);
    const avail=buildAvailList().slice(0,3);
    document.getElementById('next-pick-detail').innerHTML=
        `<strong>Pick #${nyp.pick}</strong> (Rd ${nyp.round}) ‚Äî ${gap} picks away`+
        (avail.length?`<br><span style="opacity:.55;font-size:.75rem">At risk: </span>`+avail.map(p=>`<span style="color:var(--gold-light)">${p.name}</span>`).join(', '):'');
}

// ‚îÄ‚îÄ‚îÄ Standings ‚îÄ‚îÄ‚îÄ
function computeStandings(pi){
    const acc={};
    OWNERS.forEach(o=>{acc[o]={HR:0,R:0,RBI:0,SB:0,AVG:[],W:0,SV:0,ERA:[],WHIP:[]};});
    OWNERS.forEach(owner=>{
        (pi.rosters[owner]||[]).forEach(pick=>{
            const p=S.pmap[n(pick.player)];if(!p)return;
            if(p._type==='h'){
                acc[owner].HR+=parseFloat(p.HR)||0;acc[owner].R+=parseFloat(p.R)||0;
                acc[owner].RBI+=parseFloat(p.RBI)||0;acc[owner].SB+=parseFloat(p.SB)||0;
                const avg=parseFloat(p.AVG);if(!isNaN(avg))acc[owner].AVG.push(avg);
            } else {
                acc[owner].W+=parseFloat(p.W)||0;acc[owner].SV+=parseFloat(p.SV)||0;
                const era=parseFloat(p.ERA),whip=parseFloat(p.WHIP);
                if(!isNaN(era))acc[owner].ERA.push(era);if(!isNaN(whip))acc[owner].WHIP.push(whip);
            }
        });
        acc[owner].AVG=acc[owner].AVG.length?acc[owner].AVG.reduce((a,b)=>a+b)/acc[owner].AVG.length:0;
        acc[owner].ERA=acc[owner].ERA.length?acc[owner].ERA.reduce((a,b)=>a+b)/acc[owner].ERA.length:0;
        acc[owner].WHIP=acc[owner].WHIP.length?acc[owner].WHIP.reduce((a,b)=>a+b)/acc[owner].WHIP.length:0;
    });
    const ranks={};OWNERS.forEach(o=>ranks[o]={});
    const rankCat=(cat,low=false)=>{
        const vals=OWNERS.map(o=>({o,v:acc[o][cat]})).sort((a,b)=>low?a.v-b.v:b.v-a.v);
        vals.forEach((item,i)=>ranks[item.o][cat]=OWNERS.length-i);
    };
    ['HR','R','RBI','SB','AVG','W','SV'].forEach(c=>rankCat(c));
    ['ERA','WHIP'].forEach(c=>rankCat(c,true));
    OWNERS.forEach(o=>{ranks[o].total=Object.values(ranks[o]).reduce((a,b)=>a+b,0);});
    return ranks;
}

function renderStandings(pi){
    const ranks=computeStandings(pi);
    const sorted=[...OWNERS].sort((a,b)=>ranks[b].total-ranks[a].total);
    const cats=['HR','R','RBI','SB','AVG','W','SV','ERA','WHIP'];
    document.getElementById('standings-body').innerHTML=sorted.map(o=>`
        <tr class="${o===YOU?'st-you':''}">
            <td class="st-own">${o===YOU?'‚≠ê':''}${o}</td>
            ${cats.map(c=>`<td class="r${ranks[o][c]||4}">${ranks[o][c]||'‚Äî'}</td>`).join('')}
            <td class="st-tot">${ranks[o].total||'‚Äî'}</td>
        </tr>`).join('');
}

// ‚îÄ‚îÄ‚îÄ Available Players ‚îÄ‚îÄ‚îÄ
function buildAvailList(){
    const list=[];
    S.hitters.forEach(p=>{
        if(!p.Name||S.drafted.has(n(p.Name)))return;
        list.push({rank:parseInt(p['#'])||999,name:p.Name,pos:p.Pos||'‚Äî',team:p.Team||'',s1:p.HR,s2:p.R,s3:p.RBI,s4:p.SB,war:p.WAR,_data:p,_type:'h'});
    });
    S.pitchers.forEach(p=>{
        if(!p.Name||S.drafted.has(n(p.Name)))return;
        const isRP=p.GS==='0'||p.Type==='RP'||(parseFloat(p.SV||0)>5&&parseFloat(p.GS||0)<5);
        list.push({rank:parseInt(p['#'])||999,name:p.Name,pos:isRP?'RP':'SP',team:p.Team||'',s1:p.W,s2:p.SV,s3:p['K/9']||'',s4:p.ERA,war:p.WAR,_data:p,_type:'p'});
    });
    return list.sort((a,b)=>a.rank-b.rank);
}

function filterPos(pos,btn){
    S.posFilter=pos;
    document.querySelectorAll('.pf-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');renderAvail();
}

function renderAvail(){
    let list=buildAvailList();
    if(S.posFilter!=='ALL'){
        list=list.filter(p=>{const pos=(p.pos||'').toUpperCase();if(S.posFilter==='RP')return pos==='RP'||pos==='CL';return pos===S.posFilter||pos.includes(S.posFilter);});
    }
    document.getElementById('avail-count').textContent=list.length+' avail';
    document.getElementById('avail-body').innerHTML=list.slice(0,100).map(p=>`
        <tr class="avail-row" onclick="showPlayer('${p.name.replace(/'/g,"\\'")}','${p.pos}')">
            <td class="a-rank">${p.rank}</td>
            <td class="a-name">${p.name}</td>
            <td style="background:rgba(255,255,255,.06);padding:1px 5px;border-radius:3px;font-size:.72rem;text-align:center">${p.pos}</td>
            <td style="opacity:.55">${p.team}</td>
            <td>${p.s1||'‚Äî'}</td><td>${p.s2||'‚Äî'}</td><td>${p.s3||'‚Äî'}</td>
            <td style="color:${parseFloat(p.war)>=4?'#4caf50':parseFloat(p.war)>=2?'#ffeb3b':'inherit'}">${p.war||'‚Äî'}</td>
        </tr>`).join('');
}

// ‚îÄ‚îÄ‚îÄ Pick Logger ‚îÄ‚îÄ‚îÄ
function onLoggerInput(val){
    if(val.length<2){document.getElementById('autocomplete-box').style.display='none';return;}
    const matches=buildAvailList().filter(p=>p.name.toLowerCase().includes(val.toLowerCase())).slice(0,8);
    const box=document.getElementById('autocomplete-box');
    if(!matches.length){box.style.display='none';return;}
    box.innerHTML=matches.map(p=>`
        <div class="ac-item" onclick="selectAC('${p.name.replace(/'/g,"\\'")}','${p.pos}')">
            ${p.name}<span>${p.pos} ‚Ä¢ ${p.team}</span>
        </div>`).join('');
    box.style.display='block';
}

function selectAC(name,pos){
    document.getElementById('logger-input').value=name;
    document.getElementById('logger-pos').value=pos||'';
    document.getElementById('autocomplete-box').style.display='none';
}

function onLoggerKey(e){
    if(e.key==='Enter'){logPick();}
    if(e.key==='Escape'){document.getElementById('autocomplete-box').style.display='none';}
}

async function logPick(){
    const player=document.getElementById('logger-input').value.trim();
    const pos=document.getElementById('logger-pos').value.trim();
    if(!player)return;
    const pi=computePicks();
    const cp=pi.cur;
    if(!cp){setStatus('Draft complete','err');return;}

    // Immediately add to local state for instant feedback
    localPicks[cp.pick]={player,pos};
    S.drafted.add(n(player));
    document.getElementById('logger-input').value='';
    document.getElementById('logger-pos').value='';
    document.getElementById('autocomplete-box').style.display='none';
    renderAll();
    setStatus('‚úì Logged locally','ok');

    // Try to write to Google Sheet via Apps Script
    if(scriptUrl){
        setStatus('‚ü≥ Saving to Sheet...','saving');
        try{
            await fetch(scriptUrl,{
                method:'POST',mode:'no-cors',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({pickNumber:cp.pick,player,position:pos,owner:cp.owner,round:cp.round})
            });
            setStatus('‚úì Saved to Sheet','ok');
        }catch(e){
            setStatus('‚ö† Local only (sheet offline)','err');
        }
    } else {
        setStatus('‚úì Local only (no sheet URL)','ok');
    }
}

function undoPick(){
    const pi=computePicks();
    // Find last logged pick
    const lastPickNum=Math.max(...Object.keys(pi.map).map(Number).filter(n=>n>0));
    if(localPicks[lastPickNum]){
        const player=localPicks[lastPickNum].player;
        delete localPicks[lastPickNum];
        S.drafted.delete(n(player));
        renderAll();
        setStatus('‚Ü© Undone','ok');
    } else {
        setStatus('Nothing to undo','err');
    }
}

function setStatus(msg,type){
    const el=document.getElementById('logger-status');
    el.textContent=msg;
    el.className='status-'+type;
    setTimeout(()=>{if(el.textContent===msg)el.textContent='';},3000);
}

// ‚îÄ‚îÄ‚îÄ Player Modal ‚îÄ‚îÄ‚îÄ
function showPlayer(name,pos){
    const p=S.pmap[n(name)];
    modalCurrentPlayer={name,pos};
    document.getElementById('modal-name').textContent=name;
    document.getElementById('modal-sub').textContent=(pos?pos+' ‚Ä¢ ':'')+(p?p.Team||'':'Unknown Team');
    if(p){
        let stats=[];
        if(p._type==='h'){
            stats=[{v:p.HR,l:'HR'},{v:p.R,l:'Runs'},{v:p.RBI,l:'RBI'},{v:p.SB,l:'SB'},{v:p.AVG?parseFloat(p.AVG).toFixed(3):'‚Äî',l:'AVG'},{v:p.WAR,l:'WAR'}];
        } else {
            stats=[{v:p.W,l:'Wins'},{v:p.SV,l:'Saves'},{v:p.ERA?parseFloat(p.ERA).toFixed(2):'‚Äî',l:'ERA'},{v:p.WHIP?parseFloat(p.WHIP).toFixed(2):'‚Äî',l:'WHIP'},{v:p['K/9'],l:'K/9'},{v:p.WAR,l:'WAR'}];
        }
        document.getElementById('modal-stats').innerHTML=stats.filter(s=>s.v&&s.v!=='0').map(s=>`
            <div class="stat-box"><div class="stat-val">${s.v}</div><div class="stat-lbl">${s.l}</div></div>`).join('');
    }
    document.getElementById('modal-why-text').innerHTML=generateWhy(name,p,pos);
    document.getElementById('player-modal').classList.add('open');
}

function draftFromModal(){
    if(modalCurrentPlayer){
        document.getElementById('logger-input').value=modalCurrentPlayer.name;
        document.getElementById('logger-pos').value=modalCurrentPlayer.pos||'';
        closeModal();
        document.getElementById('logger-input').focus();
    }
}

function generateWhy(name,p,pos){
    if(!p)return'Player data not in projections.';
    const war=parseFloat(p.WAR)||0;const lines=[];
    if(p._type==='h'){
        const hr=parseFloat(p.HR)||0,sb=parseFloat(p.SB)||0,avg=parseFloat(p.AVG)||0;
        if(war>=5)lines.push(`Elite WAR (${war}) ‚Äî top-tier player.`);
        else if(war>=3)lines.push(`Solid WAR (${war}) ‚Äî reliable contributor.`);
        if(hr>=35)lines.push(`Power threat: ${hr} projected HR.`);
        if(sb>=20)lines.push(`Speed asset: ${sb} projected SB.`);
        if(avg>=.290)lines.push(`High average (${parseFloat(p.AVG).toFixed(3)}) helps BA category.`);
        const pos2=(pos||'').toUpperCase();
        if(pos2==='SS'||pos2==='2B')lines.push('Premium middle infield ‚Äî scarce at this level.');
        if(pos2==='C')lines.push('Elite C ‚Äî position drops off sharply after top 2.');
    } else {
        const sv=parseFloat(p.SV)||0,w=parseFloat(p.W)||0,era=parseFloat(p.ERA)||99;
        if(sv>=30)lines.push(`Elite closer: ${sv} projected saves.`);
        else if(sv>=15)lines.push(`Save contributor: ${sv} projected saves.`);
        if(w>=14)lines.push(`Reliable wins: ${w} projected W.`);
        if(era<3.00)lines.push(`Elite ERA (${era.toFixed(2)}) ‚Äî anchors pitching.`);
        else if(era<3.50)lines.push(`Strong ERA (${era.toFixed(2)}).`);
        if(war>=4)lines.push(`Top-end SP value: ${war} WAR.`);
    }
    if(!lines.length)lines.push('Solid depth option. Check position fit with your needs.');
    return lines.map(l=>`‚Ä¢ ${l}`).join('<br>');
}

function closeModal(){document.getElementById('player-modal').classList.remove('open');modalCurrentPlayer=null;}
document.getElementById('player-modal').addEventListener('click',function(e){if(e.target===this)closeModal();});

// ‚îÄ‚îÄ‚îÄ Apps Script Setup ‚îÄ‚îÄ‚îÄ
function openSetup(){document.getElementById('setup-modal').classList.add('open');}
function skipSetup(){document.getElementById('setup-modal').classList.remove('open');}
function saveScriptUrl(){
    const url=document.getElementById('setup-url').value.trim();
    if(url){scriptUrl=url;localStorage.setItem('rd_script_url',url);setStatus('‚úì Script URL saved','ok');}
    skipSetup();
}
// Show setup on first load if no script URL
if(!scriptUrl) setTimeout(()=>document.getElementById('setup-modal').classList.add('open'),2000);

loadAll();
setInterval(loadAll,90000);
</script>
</body>
</html>
