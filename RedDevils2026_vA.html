<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Red Devils 2026 ‚Äî Draft Day (Version A)</title>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Roboto+Condensed:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --navy: #1a2744; --navy-light: #2d4263;
            --gold: #d4af37; --gold-light: #f4d675;
            --red: #c41e3a; --green: #2e7d32;
            --white: #f5f5f5;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        html, body { height:100%; overflow:hidden; }
        body {
            font-family:'Roboto Condensed',sans-serif;
            background:linear-gradient(135deg,var(--navy) 0%,#0d1520 100%);
            color:var(--white); display:flex; flex-direction:column;
        }

        /* ‚îÄ‚îÄ Loading ‚îÄ‚îÄ */
        #loader {
            position:fixed; inset:0; background:var(--navy);
            display:flex; flex-direction:column; align-items:center; justify-content:center;
            z-index:9999; transition:opacity .5s;
        }
        #loader.gone { opacity:0; pointer-events:none; }
        .spin {
            width:56px; height:56px; border-radius:50%;
            border:5px solid rgba(212,175,55,.3); border-top-color:var(--gold);
            animation:spin 1s linear infinite; margin-bottom:16px;
        }
        @keyframes spin { to { transform:rotate(360deg); } }
        .load-title { font-family:'Oswald',sans-serif; font-size:1.4rem; color:var(--gold); }
        .load-sub { font-size:.85rem; opacity:.6; margin-top:6px; }

        /* ‚îÄ‚îÄ Top Banner ‚îÄ‚îÄ */
        #top-banner {
            background:linear-gradient(90deg,var(--red),#8b0000);
            border-bottom:3px solid var(--gold);
            padding:10px 20px;
            display:flex; align-items:center; justify-content:space-between;
            flex-shrink:0;
        }
        #top-banner h1 {
            font-family:'Oswald',sans-serif; font-size:1.6rem;
            text-transform:uppercase; letter-spacing:3px;
        }
        #banner-center {
            font-family:'Oswald',sans-serif; font-size:1.1rem;
            text-align:center; flex:1; padding:0 20px;
        }
        #current-pick-label { font-size:1.4rem; font-weight:700; }
        #on-deck-label { font-size:.85rem; opacity:.7; margin-top:2px; }
        #your-turn-pill {
            padding:8px 20px; border-radius:6px;
            font-family:'Oswald',sans-serif; font-size:1rem; font-weight:700;
            white-space:nowrap;
        }
        #your-turn-pill.active {
            background:var(--green); color:#fff;
            animation:pulse 1.5s infinite;
        }
        #your-turn-pill.waiting { background:rgba(255,255,255,.1); color:var(--gold); }
        @keyframes pulse {
            0%,100%{transform:scale(1);}
            50%{transform:scale(1.05);box-shadow:0 0 18px rgba(46,125,50,.8);}
        }
        .refresh-btn {
            background:rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.25);
            color:#fff; padding:5px 14px; border-radius:4px; cursor:pointer;
            font-family:'Oswald',sans-serif; font-size:.82rem; margin-left:10px;
        }
        .refresh-btn:hover { background:rgba(255,255,255,.22); }
        #last-sync { font-size:.72rem; opacity:.5; margin-top:3px; text-align:right; }

        /* ‚îÄ‚îÄ Round Strip ‚îÄ‚îÄ */
        #round-strip {
            background:rgba(0,0,0,.35); padding:8px 20px;
            display:flex; gap:6px; align-items:center;
            overflow-x:auto; flex-shrink:0;
        }
        .round-label { font-family:'Oswald',sans-serif; font-size:.8rem; opacity:.5; margin-right:4px; }
        .rs-slot {
            padding:5px 12px; border-radius:6px; text-align:center;
            font-family:'Oswald',sans-serif; font-size:.85rem;
            background:rgba(255,255,255,.06);
            border:1px solid rgba(255,255,255,.1);
            white-space:nowrap;
        }
        .rs-slot.you { border-color:var(--gold); color:var(--gold); }
        .rs-slot.active { background:var(--gold); color:var(--navy); border-color:var(--gold); font-weight:700; }
        .rs-slot.done { opacity:.3; }

        /* ‚îÄ‚îÄ Main Grid ‚îÄ‚îÄ */
        #main-grid {
            flex:1; display:grid;
            grid-template-columns:1fr 380px;
            grid-template-rows:1fr auto;
            gap:0; overflow:hidden;
        }

        /* ‚îÄ‚îÄ Draft Log (left top) ‚îÄ‚îÄ */
        #draft-log-panel {
            grid-row:1; grid-column:1;
            display:flex; flex-direction:column;
            border-right:1px solid rgba(255,255,255,.08);
            overflow:hidden;
        }
        .panel-header {
            background:var(--navy-light); padding:10px 16px;
            font-family:'Oswald',sans-serif; font-size:1rem;
            text-transform:uppercase; letter-spacing:2px;
            border-bottom:2px solid var(--gold); flex-shrink:0;
            display:flex; justify-content:space-between; align-items:center;
        }
        #draft-log-scroll {
            flex:1; overflow-y:auto; padding:0;
        }
        #draft-log-scroll::-webkit-scrollbar { width:5px; }
        #draft-log-scroll::-webkit-scrollbar-thumb { background:var(--gold); border-radius:3px; }

        .pick-row {
            display:grid; grid-template-columns:52px 90px 1fr 54px;
            padding:8px 14px; border-bottom:1px solid rgba(255,255,255,.06);
            align-items:center; cursor:default;
            transition:background .15s;
        }
        .pick-row:hover { background:rgba(255,255,255,.05); }
        .pick-row.yours { background:rgba(212,175,55,.12); border-left:3px solid var(--gold); }
        .pick-row.current { background:rgba(212,175,55,.08); border-left:3px solid rgba(212,175,55,.4); }
        .pick-row.empty { opacity:.3; }
        .pr-num { font-family:'Oswald',sans-serif; font-size:1rem; color:var(--gold); }
        .pr-owner { font-size:.8rem; opacity:.6; font-weight:700; }
        .pr-player { font-size:1rem; font-weight:700; }
        .pr-player.clickable { cursor:pointer; color:var(--gold-light); }
        .pr-player.clickable:hover { text-decoration:underline; }
        .pr-pos {
            background:var(--navy); padding:2px 8px; border-radius:4px;
            font-size:.78rem; font-weight:700; text-align:center;
        }

        /* ‚îÄ‚îÄ Available Players (left bottom) ‚îÄ‚îÄ */
        #avail-panel {
            grid-row:2; grid-column:1;
            border-right:1px solid rgba(255,255,255,.08);
            border-top:1px solid rgba(255,255,255,.08);
            display:flex; flex-direction:column;
            max-height:40vh;
        }
        .pos-filters { display:flex; gap:5px; padding:8px 14px; flex-wrap:wrap; flex-shrink:0; }
        .pf-btn {
            padding:4px 12px; border-radius:20px; border:1px solid rgba(255,255,255,.2);
            background:rgba(255,255,255,.07); color:#fff; cursor:pointer;
            font-size:.78rem; transition:all .15s;
        }
        .pf-btn.active { background:var(--gold); color:var(--navy); border-color:var(--gold); }
        #avail-scroll { flex:1; overflow-y:auto; }
        #avail-scroll::-webkit-scrollbar { width:5px; }
        #avail-scroll::-webkit-scrollbar-thumb { background:var(--gold); border-radius:3px; }
        .avail-row {
            display:grid; grid-template-columns:36px 1fr 44px 40px 44px 44px 44px 50px;
            padding:5px 14px; border-bottom:1px solid rgba(255,255,255,.05);
            font-size:.82rem; align-items:center; cursor:pointer;
        }
        .avail-row:hover { background:rgba(255,255,255,.06); }
        .avail-row.header { background:var(--navy); font-family:'Oswald',sans-serif; font-size:.75rem; text-transform:uppercase; cursor:default; position:sticky; top:0; }
        .avail-rank { color:var(--gold); font-weight:700; }
        .avail-name { font-weight:700; color:var(--gold-light); }
        .avail-name:hover { text-decoration:underline; }
        .pos-tag { background:var(--navy-light); padding:1px 6px; border-radius:3px; font-size:.72rem; text-align:center; }

        /* ‚îÄ‚îÄ Right Column ‚îÄ‚îÄ */
        #right-col {
            grid-row:1/3; grid-column:2;
            display:flex; flex-direction:column;
            overflow:hidden;
        }

        /* Your Team */
        #your-team-panel {
            flex:0 0 auto;
            border-bottom:1px solid rgba(255,255,255,.08);
        }
        .your-team-header {
            background:linear-gradient(90deg,var(--gold),var(--gold-light));
            color:var(--navy) !important;
        }
        #your-roster { padding:10px 14px; overflow-y:auto; max-height:28vh; }
        #your-roster::-webkit-scrollbar { width:4px; }
        #your-roster::-webkit-scrollbar-thumb { background:var(--gold); border-radius:2px; }
        .roster-item {
            display:flex; justify-content:space-between; align-items:center;
            padding:4px 0; border-bottom:1px solid rgba(255,255,255,.05);
            font-size:.85rem;
        }
        .ri-round { color:var(--gold); font-size:.75rem; width:24px; flex-shrink:0; }
        .ri-name { flex:1; padding:0 6px; }
        .ri-pos { font-size:.72rem; opacity:.55; }
        .ri-keeper { color:#4caf50; font-size:.72rem; }
        #needs-bar { padding:8px 14px; display:flex; flex-wrap:wrap; gap:4px; }
        .need-tag {
            background:var(--red); color:#fff; padding:2px 8px;
            border-radius:12px; font-size:.72rem; font-weight:700;
        }
        #next-pick-box {
            margin:0 14px 10px; padding:8px 12px;
            background:rgba(212,175,55,.15); border:1px solid rgba(212,175,55,.4);
            border-radius:6px; font-size:.82rem;
        }
        #next-pick-box .npb-label { color:var(--gold); font-family:'Oswald',sans-serif; font-size:.8rem; text-transform:uppercase; letter-spacing:1px; margin-bottom:4px; }

        /* Standings */
        #standings-panel { flex:1; display:flex; flex-direction:column; overflow:hidden; }
        #standings-scroll { flex:1; overflow-y:auto; padding:0; }
        #standings-scroll::-webkit-scrollbar { width:4px; }
        #standings-scroll::-webkit-scrollbar-thumb { background:var(--gold); border-radius:2px; }
        .st-table { width:100%; border-collapse:collapse; font-size:.78rem; }
        .st-table th {
            background:var(--navy); padding:7px 5px; text-align:center;
            font-family:'Oswald',sans-serif; font-size:.7rem; text-transform:uppercase;
            position:sticky; top:0;
        }
        .st-table td { padding:6px 5px; text-align:center; border-bottom:1px solid rgba(255,255,255,.07); }
        .st-owner { text-align:left !important; padding-left:10px !important; font-weight:700; font-size:.82rem; }
        .st-you { background:rgba(212,175,55,.12); border-left:3px solid var(--gold); }
        .r1{color:#4caf50;font-weight:700;} .r2{color:#8bc34a;} .r3{color:#cddc39;}
        .r4{color:#ffeb3b;} .r5{color:#ff9800;} .r6{color:#ff5722;} .r7{color:#f44336;font-weight:700;}
        .st-total { font-family:'Oswald',sans-serif; font-size:.95rem; font-weight:700; color:var(--gold); }

        /* ‚îÄ‚îÄ Player Modal ‚îÄ‚îÄ */
        #player-modal {
            display:none; position:fixed; inset:0;
            background:rgba(0,0,0,.75); z-index:1000;
            align-items:center; justify-content:center;
        }
        #player-modal.open { display:flex; }
        #modal-box {
            background:linear-gradient(135deg,var(--navy-light),var(--navy));
            border:2px solid var(--gold); border-radius:12px;
            padding:24px; width:480px; max-width:95vw;
            position:relative;
        }
        #modal-close {
            position:absolute; top:12px; right:16px;
            background:none; border:none; color:var(--gold);
            font-size:1.4rem; cursor:pointer;
        }
        #modal-name { font-family:'Oswald',sans-serif; font-size:1.6rem; font-weight:700; margin-bottom:4px; }
        #modal-sub { opacity:.6; font-size:.88rem; margin-bottom:16px; }
        .modal-stats { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:16px; }
        .stat-box { background:rgba(255,255,255,.06); border-radius:6px; padding:10px; text-align:center; }
        .stat-val { font-family:'Oswald',sans-serif; font-size:1.4rem; font-weight:700; color:var(--gold); }
        .stat-lbl { font-size:.72rem; opacity:.6; text-transform:uppercase; margin-top:2px; }
        #modal-why { background:rgba(212,175,55,.1); border:1px solid rgba(212,175,55,.3); border-radius:6px; padding:12px; font-size:.88rem; line-height:1.5; }
        #modal-why-title { font-family:'Oswald',sans-serif; color:var(--gold); font-size:.8rem; text-transform:uppercase; letter-spacing:1px; margin-bottom:6px; }
    </style>
</head>
<body>

<div id="loader">
    <div class="spin"></div>
    <div class="load-title">üî¥ Red Devils 2026</div>
    <div class="load-sub" id="load-sub">Connecting to Google Sheets...</div>
</div>

<!-- Top Banner -->
<div id="top-banner">
    <h1>üî¥ Red Devils 2026</h1>
    <div id="banner-center">
        <div id="current-pick-label">Loading...</div>
        <div id="on-deck-label"></div>
    </div>
    <div style="display:flex;flex-direction:column;align-items:flex-end">
        <div style="display:flex;align-items:center;gap:8px">
            <div id="your-turn-pill" class="waiting">Loading...</div>
            <button class="refresh-btn" onclick="loadAll()">üîÑ</button>
        </div>
        <div id="last-sync">Last sync: ‚Äî</div>
    </div>
</div>

<!-- Round Strip -->
<div id="round-strip">
    <span class="round-label">ROUND</span>
    <span id="round-num" style="font-family:'Oswald',sans-serif;color:var(--gold);margin-right:8px">1</span>
    <div id="rs-slots"></div>
</div>

<!-- Main Grid -->
<div id="main-grid">

    <!-- Draft Log -->
    <div id="draft-log-panel">
        <div class="panel-header">
            üìã Draft Log
            <span id="picks-count" style="font-size:.8rem;opacity:.6">0 / 161 picks</span>
        </div>
        <div id="draft-log-scroll"></div>
    </div>

    <!-- Available Players -->
    <div id="avail-panel">
        <div class="panel-header">
            ‚öæ Available Players
            <span id="avail-count" style="font-size:.8rem;opacity:.6"></span>
        </div>
        <div class="pos-filters">
            <button class="pf-btn active" onclick="filterPos('ALL',this)">All</button>
            <button class="pf-btn" onclick="filterPos('C',this)">C</button>
            <button class="pf-btn" onclick="filterPos('1B',this)">1B</button>
            <button class="pf-btn" onclick="filterPos('2B',this)">2B</button>
            <button class="pf-btn" onclick="filterPos('3B',this)">3B</button>
            <button class="pf-btn" onclick="filterPos('SS',this)">SS</button>
            <button class="pf-btn" onclick="filterPos('OF',this)">OF</button>
            <button class="pf-btn" onclick="filterPos('SP',this)">SP</button>
            <button class="pf-btn" onclick="filterPos('RP',this)">RP/CL</button>
        </div>
        <div id="avail-scroll">
            <table style="width:100%;border-collapse:collapse">
                <thead>
                    <tr class="avail-row header">
                        <td>#</td><td>Player</td><td>Pos</td><td>Team</td>
                        <td>HR/W</td><td>R/SV</td><td>RBI/K</td><td>WAR</td>
                    </tr>
                </thead>
                <tbody id="avail-body"></tbody>
            </table>
        </div>
    </div>

    <!-- Right Column -->
    <div id="right-col">

        <!-- Your Team -->
        <div id="your-team-panel">
            <div class="panel-header your-team-header">‚≠ê QUICKSTER ‚Äî YOUR TEAM</div>
            <div id="your-roster"></div>
            <div id="needs-bar"></div>
            <div id="next-pick-box">
                <div class="npb-label">‚è± Next Pick</div>
                <div id="next-pick-detail">Loading...</div>
            </div>
        </div>

        <!-- Standings -->
        <div id="standings-panel">
            <div class="panel-header">üìä Live Roto Standings</div>
            <div id="standings-scroll">
                <table class="st-table">
                    <thead>
                        <tr>
                            <th class="st-owner">Owner</th>
                            <th>HR</th><th>R</th><th>RBI</th><th>SB</th><th>AVG</th>
                            <th>W</th><th>SV</th><th>ERA</th><th>WHIP</th><th>TOT</th>
                        </tr>
                    </thead>
                    <tbody id="standings-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Player Detail Modal -->
<div id="player-modal">
    <div id="modal-box">
        <button id="modal-close" onclick="closeModal()">‚úï</button>
        <div id="modal-name"></div>
        <div id="modal-sub"></div>
        <div class="modal-stats" id="modal-stats"></div>
        <div id="modal-why">
            <div id="modal-why-title">üí° Why Draft This Player?</div>
            <div id="modal-why-text"></div>
        </div>
    </div>
</div>

<script>
const URLS = {
    draftBoard:'https://docs.google.com/spreadsheets/d/e/2PACX-1vQyBE1r8gfR4CJXJcHQLrmGTCpzDfYzCaQOeKe75RblsR_HR2q76GRWfyl8PTK2yQ/pub?gid=1638949988&single=true&output=csv',
    hitters:'https://docs.google.com/spreadsheets/d/e/2PACX-1vQyBE1r8gfR4CJXJcHQLrmGTCpzDfYzCaQOeKe75RblsR_HR2q76GRWfyl8PTK2yQ/pub?gid=150056456&single=true&output=csv',
    pitchers:'https://docs.google.com/spreadsheets/d/e/2PACX-1vQyBE1r8gfR4CJXJcHQLrmGTCpzDfYzCaQOeKe75RblsR_HR2q76GRWfyl8PTK2yQ/pub?gid=563628934&single=true&output=csv',
    keepers:'https://docs.google.com/spreadsheets/d/e/2PACX-1vQyBE1r8gfR4CJXJcHQLrmGTCpzDfYzCaQOeKe75RblsR_HR2q76GRWfyl8PTK2yQ/pub?gid=1016378708&single=true&output=csv',
};
const OWNERS = ['Bubs','Furman','Quickster','Cone','Vic','TK','Rich'];
const YOU = 'Quickster';
const ROUNDS = 23;

function buildSnake() {
    const order = [];
    for(let r=1;r<=ROUNDS;r++){
        const row = r%2===1 ? [...OWNERS] : [...OWNERS].reverse();
        row.forEach((o,i)=>order.push({pick:order.length+1,round:r,rp:i+1,owner:o}));
    }
    return order;
}
const SNAKE = buildSnake();

function parseCSV(txt) {
    const lines = txt.trim().split('\n');
    const hdr = parseLine(lines[0]);
    return lines.slice(1).filter(l=>l.trim()).map(l=>{
        const v = parseLine(l);
        const o={};
        hdr.forEach((h,i)=>o[h.trim()]=(v[i]||'').trim());
        return o;
    });
}
function parseLine(line) {
    const r=[];let c='',q=false;
    for(let ch of line){
        if(ch==='"'){q=!q;}
        else if(ch===','&&!q){r.push(c);c='';}
        else c+=ch;
    }
    r.push(c);return r;
}
async function csv(url){
    const r=await fetch(url);
    if(!r.ok)throw new Error('fetch failed');
    return parseCSV(await r.text());
}

let S = {
    db:[], hitters:[], pitchers:[], keepers:[],
    pmap:{}, drafted:new Set(),
    posFilter:'ALL',
};

async function loadAll() {
    document.getElementById('load-sub').textContent='Fetching data...';
    try {
        const [db,h,p,k] = await Promise.all([csv(URLS.draftBoard),csv(URLS.hitters),csv(URLS.pitchers),csv(URLS.keepers)]);
        S.db=db; S.hitters=h; S.pitchers=p; S.keepers=k;
        S.pmap={};
        h.forEach(p=>{if(p.Name)S.pmap[n(p.Name)]={...p,_type:'h'};});
        p.forEach(p=>{if(p.Name)S.pmap[n(p.Name)]={...p,_type:'p'};});
        S.drafted=new Set();
        db.forEach(row=>{const pl=(row.Player||'').trim();if(pl)S.drafted.add(n(pl));});
        renderAll();
        document.getElementById('last-sync').textContent='Last sync: '+new Date().toLocaleTimeString();
    } catch(e) {
        document.getElementById('load-sub').textContent='Error: '+e.message;
        console.error(e);
    }
    const ld=document.getElementById('loader');
    ld.classList.add('gone');
    setTimeout(()=>ld.style.display='none',600);
}

function n(s){return(s||'').toLowerCase().trim();}

function renderAll(){
    const pi = computePicks();
    renderBanner(pi);
    renderRoundStrip(pi);
    renderDraftLog(pi);
    renderYourTeam(pi);
    renderStandings(pi);
    renderAvail();
    renderNextPick(pi);
}

function computePicks(){
    const map={};
    S.db.forEach(row=>{
        const num=parseInt(row['Pick#']||row['Pick #']||0);
        if(!num)return;
        const pl=(row.Player||'').trim();
        if(pl)map[num]={player:pl,pos:(row.Position||'').trim(),team:(row.Team||'').trim()};
    });
    let curIdx=-1;
    for(let i=0;i<SNAKE.length;i++){
        if(!map[SNAKE[i].pick]){curIdx=i;break;}
    }
    if(curIdx===-1)curIdx=SNAKE.length;
    const cur=SNAKE[curIdx]||null;
    const nyp=SNAKE.find((p,i)=>i>=curIdx&&p.owner===YOU)||null;
    const rosters={};
    OWNERS.forEach(o=>rosters[o]=[]);
    Object.entries(map).forEach(([num,d])=>{
        const info=SNAKE[parseInt(num)-1];
        if(info)rosters[info.owner].push({...d,round:info.round});
    });
    // add keepers
    S.keepers.forEach(row=>{
        const owner=(row.Owner||'').replace(' (Mic)','').replace('Quickster (Mic)','Quickster').trim();
        ['1','2'].forEach(i=>{
            const k=(row[`Keeper ${i}`]||'').trim();
            const kp=(row[`K${i} Position`]||'').trim();
            if(k&&k!=='TBD'&&rosters[owner])rosters[owner].unshift({player:k,pos:kp,round:0,isKeeper:true});
        });
    });
    return{curIdx,cur,nyp,map,rosters,madeCount:Object.keys(map).length};
}

function renderBanner(pi){
    const cp=pi.cur;
    if(!cp){
        document.getElementById('current-pick-label').textContent='üèÜ DRAFT COMPLETE';
        document.getElementById('your-turn-pill').textContent='Done';
        return;
    }
    document.getElementById('current-pick-label').textContent=`üìç Pick ${cp.pick} ‚Äî Rd ${cp.round} (${cp.owner.toUpperCase()})`;
    const next=SNAKE[pi.curIdx+1];
    document.getElementById('on-deck-label').textContent=next?`On deck: ${next.owner} (#${next.pick})`:'';
    const pill=document.getElementById('your-turn-pill');
    if(cp.owner===YOU){
        pill.textContent='üî• YOUR TURN ‚Äî PICK NOW!';
        pill.className='your-turn-pill active';
    } else {
        pill.textContent=pi.nyp?`Your pick: #${pi.nyp.pick} (Rd ${pi.nyp.round})`:'';
        pill.className='your-turn-pill waiting';
    }
    document.getElementById('picks-count').textContent=`${pi.madeCount} / 161 picks`;
}

function renderRoundStrip(pi){
    const cp=pi.cur;
    const round=cp?cp.round:ROUNDS;
    document.getElementById('round-num').textContent=round;
    const picks=SNAKE.filter(p=>p.round===round);
    document.getElementById('rs-slots').innerHTML=picks.map(p=>{
        let cls='rs-slot';
        if(p.owner===YOU)cls+=' you';
        if(cp&&p.pick===cp.pick)cls+=' active';
        else if(cp&&p.pick<cp.pick)cls+=' done';
        return`<div class="${cls}">${p.rp}. ${p.owner}</div>`;
    }).join('');
}

function renderDraftLog(pi){
    const el=document.getElementById('draft-log-scroll');
    const from=Math.max(0,pi.curIdx-20);
    const to=Math.min(SNAKE.length-1,pi.curIdx+12);
    let html='';
    for(let i=from;i<=to;i++){
        const p=SNAKE[i];
        const d=pi.map[p.pick];
        const isYou=p.owner===YOU;
        const isCur=pi.cur&&p.pick===pi.cur.pick;
        let cls='pick-row';
        if(isYou&&d)cls+=' yours';
        if(isCur)cls+=' current';
        if(!d)cls+=' empty';
        const playerHtml=d
            ?`<span class="pr-player clickable" onclick="showPlayer('${d.player.replace(/'/g,"\\'")}','${d.pos}')">${d.player}</span>`
            :isCur?`<span class="pr-player" style="opacity:.5;font-style:italic">‚è± On clock...</span>`
            :`<span class="pr-player" style="opacity:.2">‚Äî</span>`;
        html+=`<div class="${cls}">
            <span class="pr-num">${p.round}.${String(p.rp).padStart(2,'0')}</span>
            <span class="pr-owner">${isYou?'‚≠ê ':''} ${p.owner}</span>
            ${playerHtml}
            <span class="pr-pos">${d?d.pos:''}</span>
        </div>`;
    }
    el.innerHTML=html;
    setTimeout(()=>{
        const cur=el.querySelector('.current');
        if(cur)cur.scrollIntoView({behavior:'smooth',block:'center'});
    },100);
}

function renderYourTeam(pi){
    const roster=pi.rosters[YOU]||[];
    let html='';
    roster.forEach(p=>{
        html+=`<div class="roster-item">
            <span class="ri-round">${p.isKeeper?'üîí':('R'+p.round)}</span>
            <span class="ri-name">${p.player}</span>
            <span class="ri-pos">${p.pos||''}</span>
        </div>`;
    });
    if(!html)html='<div style="padding:10px;opacity:.4;font-size:.85rem">No picks yet</div>';
    document.getElementById('your-roster').innerHTML=html;

    // needs
    const posCount={};
    roster.forEach(p=>{const pos=(p.pos||'').toUpperCase();posCount[pos]=(posCount[pos]||0)+1;});
    const needs={C:1,'1B':2,'2B':2,'3B':1,SS:1,MI:1,CI:1,OF:5,SP:6,RP:3,UT:2};
    const needTags=[];
    Object.entries(needs).forEach(([pos,req])=>{
        const have=posCount[pos]||0;
        if(have<req)needTags.push(pos+(req-have>1?` √ó${req-have}`:''));
    });
    document.getElementById('needs-bar').innerHTML=needTags.map(t=>`<span class="need-tag">${t}</span>`).join('')||'<span style="color:#4caf50;font-size:.82rem;padding:8px 14px">‚úÖ All filled!</span>';
}

function renderNextPick(pi){
    const nyp=pi.nyp;
    if(!nyp){document.getElementById('next-pick-detail').textContent='No picks remaining';return;}
    const gap=nyp.pick-(pi.cur?pi.cur.pick:nyp.pick);
    const avail=buildAvailList().slice(0,3);
    let html=`<strong>Pick #${nyp.pick}</strong> (Round ${nyp.round}) ‚Äî ${gap} picks away<br>`;
    if(avail.length){
        html+=`<span style="opacity:.6;font-size:.78rem">At risk of being gone: </span>`;
        html+=avail.map(p=>`<span style="color:var(--gold-light)">${p.name}</span>`).join(', ');
    }
    document.getElementById('next-pick-detail').innerHTML=html;
}

function computeStandings(pi){
    const acc={};
    OWNERS.forEach(o=>{acc[o]={HR:0,R:0,RBI:0,SB:0,AVG:[],W:0,SV:0,ERA:[],WHIP:[]};});
    OWNERS.forEach(owner=>{
        (pi.rosters[owner]||[]).forEach(pick=>{
            const p=S.pmap[n(pick.player)];
            if(!p)return;
            if(p._type==='h'){
                acc[owner].HR+=parseFloat(p.HR)||0;
                acc[owner].R+=parseFloat(p.R)||0;
                acc[owner].RBI+=parseFloat(p.RBI)||0;
                acc[owner].SB+=parseFloat(p.SB)||0;
                const avg=parseFloat(p.AVG);
                if(!isNaN(avg))acc[owner].AVG.push(avg);
            } else {
                acc[owner].W+=parseFloat(p.W)||0;
                acc[owner].SV+=parseFloat(p.SV)||0;
                const era=parseFloat(p.ERA),whip=parseFloat(p.WHIP);
                if(!isNaN(era))acc[owner].ERA.push(era);
                if(!isNaN(whip))acc[owner].WHIP.push(whip);
            }
        });
        acc[owner].AVG=acc[owner].AVG.length?acc[owner].AVG.reduce((a,b)=>a+b)/acc[owner].AVG.length:0;
        acc[owner].ERA=acc[owner].ERA.length?acc[owner].ERA.reduce((a,b)=>a+b)/acc[owner].ERA.length:0;
        acc[owner].WHIP=acc[owner].WHIP.length?acc[owner].WHIP.reduce((a,b)=>a+b)/acc[owner].WHIP.length:0;
    });
    const ranks={};
    OWNERS.forEach(o=>ranks[o]={});
    const rankCat=(cat,low=false)=>{
        const vals=OWNERS.map(o=>({o,v:acc[o][cat]})).sort((a,b)=>low?a.v-b.v:b.v-a.v);
        vals.forEach((item,i)=>ranks[item.o][cat]=OWNERS.length-i);
    };
    ['HR','R','RBI','SB','AVG','W','SV'].forEach(c=>rankCat(c));
    ['ERA','WHIP'].forEach(c=>rankCat(c,true));
    OWNERS.forEach(o=>{ranks[o].total=Object.values(ranks[o]).reduce((a,b)=>a+b,0);});
    return ranks;
}

function renderStandings(pi){
    const ranks=computeStandings(pi);
    const sorted=[...OWNERS].sort((a,b)=>ranks[b].total-ranks[a].total);
    const cats=['HR','R','RBI','SB','AVG','W','SV','ERA','WHIP'];
    document.getElementById('standings-body').innerHTML=sorted.map(o=>`
        <tr class="${o===YOU?'st-you':''}">
            <td class="st-owner">${o===YOU?'‚≠ê ':''}${o}</td>
            ${cats.map(c=>`<td class="r${ranks[o][c]||4}">${ranks[o][c]||'‚Äî'}</td>`).join('')}
            <td class="st-total">${ranks[o].total||'‚Äî'}</td>
        </tr>`).join('');
}

function buildAvailList(){
    const list=[];
    S.hitters.forEach(p=>{
        if(!p.Name||S.drafted.has(n(p.Name)))return;
        list.push({rank:parseInt(p['#'])||999,name:p.Name,pos:p.Pos||'‚Äî',team:p.Team||'',
            s1:p.HR,s2:p.R,s3:p.RBI,s4:p.SB,war:p.WAR,_data:p,_type:'h'});
    });
    S.pitchers.forEach(p=>{
        if(!p.Name||S.drafted.has(n(p.Name)))return;
        const isRP=p.GS==='0'||p.Type==='RP'||(parseFloat(p.SV||0)>5&&parseFloat(p.GS||0)<5);
        list.push({rank:parseInt(p['#'])||999,name:p.Name,pos:isRP?'RP':'SP',team:p.Team||'',
            s1:p.W,s2:p.SV,s3:p['K/9']||'',s4:p.ERA,war:p.WAR,_data:p,_type:'p'});
    });
    return list.sort((a,b)=>a.rank-b.rank);
}

function filterPos(pos,btn){
    S.posFilter=pos;
    document.querySelectorAll('.pf-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    renderAvail();
}

function renderAvail(){
    let list=buildAvailList();
    if(S.posFilter!=='ALL'){
        list=list.filter(p=>{
            const pos=(p.pos||'').toUpperCase();
            if(S.posFilter==='RP')return pos==='RP'||pos==='CL';
            return pos===S.posFilter||pos.includes(S.posFilter);
        });
    }
    document.getElementById('avail-count').textContent=list.length+' available';
    document.getElementById('avail-body').innerHTML=list.slice(0,100).map(p=>`
        <tr class="avail-row" onclick="showPlayer('${p.name.replace(/'/g,"\\'")}','${p.pos}')">
            <td class="avail-rank">${p.rank}</td>
            <td class="avail-name">${p.name}</td>
            <td><span class="pos-tag">${p.pos}</span></td>
            <td style="opacity:.6">${p.team}</td>
            <td>${p.s1||'‚Äî'}</td>
            <td>${p.s2||'‚Äî'}</td>
            <td>${p.s3||'‚Äî'}</td>
            <td style="color:${parseFloat(p.war)>=4?'#4caf50':parseFloat(p.war)>=2?'#ffeb3b':'inherit'}">${p.war||'‚Äî'}</td>
        </tr>`).join('');
}

function showPlayer(name, pos){
    const p=S.pmap[n(name)];
    document.getElementById('modal-name').textContent=name;
    document.getElementById('modal-sub').textContent=(pos?pos+' ‚Ä¢ ':'')+(p?p.Team||'':'');
    document.getElementById('modal-stats').innerHTML='';
    if(p){
        let stats=[];
        if(p._type==='h'){
            stats=[
                {v:p.HR,l:'Home Runs'},{v:p.R,l:'Runs'},{v:p.RBI,l:'RBI'},{v:p.SB,l:'Stolen Bases'},
                {v:p.AVG?parseFloat(p.AVG).toFixed(3):'‚Äî',l:'Batting Avg'},{v:p.wRC||p['wRC+'],l:'wRC+'},{v:p.WAR,l:'WAR'},{v:p.OBP?parseFloat(p.OBP).toFixed(3):'‚Äî',l:'OBP'}
            ];
        } else {
            stats=[
                {v:p.W,l:'Wins'},{v:p.SV,l:'Saves'},{v:p.ERA?parseFloat(p.ERA).toFixed(2):'‚Äî',l:'ERA'},
                {v:p.WHIP?parseFloat(p.WHIP).toFixed(2):'‚Äî',l:'WHIP'},{v:p['K/9'],l:'K/9'},{v:p.IP,l:'IP'},{v:p.WAR,l:'WAR'},{v:p.FIP?parseFloat(p.FIP).toFixed(2):'‚Äî',l:'FIP'}
            ];
        }
        document.getElementById('modal-stats').innerHTML=stats.filter(s=>s.v&&s.v!=='0').slice(0,6).map(s=>`
            <div class="stat-box"><div class="stat-val">${s.v}</div><div class="stat-lbl">${s.l}</div></div>`).join('');
    }
    document.getElementById('modal-why-text').innerHTML=generateWhy(name,p,pos);
    document.getElementById('player-modal').classList.add('open');
}

function generateWhy(name,p,pos){
    if(!p)return'Player data not found in projections.';
    const war=parseFloat(p.WAR)||0;
    const lines=[];
    if(p._type==='h'){
        const hr=parseFloat(p.HR)||0,sb=parseFloat(p.SB)||0,avg=parseFloat(p.AVG)||0;
        if(war>=5)lines.push(`Elite WAR projection (${war}) ‚Äî top-tier player.`);
        else if(war>=3)lines.push(`Solid WAR projection (${war}) ‚Äî reliable contributor.`);
        if(hr>=35)lines.push(`Power threat with ${hr} projected HR.`);
        if(sb>=20)lines.push(`Speed asset ‚Äî ${sb} projected SB boosts your SB category.`);
        if(avg>=.290)lines.push(`High average (${parseFloat(p.AVG).toFixed(3)}) helps the BA category.`);
        const pos2=(pos||'').toUpperCase();
        if(pos2==='SS'||pos2==='2B')lines.push('Premium up-the-middle position ‚Äî scarce at this level.');
        if(pos2==='C')lines.push('Catcher depth drops sharply ‚Äî elite C is draft-worthy early.');
    } else {
        const sv=parseFloat(p.SV)||0,w=parseFloat(p.W)||0,era=parseFloat(p.ERA)||99;
        if(sv>=30)lines.push(`Elite closer ‚Äî ${sv} projected saves.`);
        else if(sv>=15)lines.push(`Save contributor ‚Äî ${sv} projected saves.`);
        if(w>=14)lines.push(`Reliable wins (${w} projected W).`);
        if(era<3.00)lines.push(`Elite ERA projection (${era.toFixed(2)}) ‚Äî anchors pitching.`);
        else if(era<3.50)lines.push(`Strong ERA (${era.toFixed(2)}) ‚Äî helps the pitching categories.`);
        if(war>=4)lines.push(`Top-end SP value ‚Äî ${war} WAR projection.`);
    }
    if(!lines.length)lines.push('Solid depth option. Check position fit with your roster needs.');
    return lines.map(l=>`‚Ä¢ ${l}`).join('<br>');
}

function closeModal(){
    document.getElementById('player-modal').classList.remove('open');
}
document.getElementById('player-modal').addEventListener('click',function(e){
    if(e.target===this)closeModal();
});

loadAll();
setInterval(loadAll, 90000);
</script>
</body>
</html>
